SUBROUTINE OPTIM_QUIP_WRAPPER(NAT,CRDS,GRAD,ENRG)

USE COMMONS, ONLY : NATOMS
USE KEY, ONLY : QUIPZ, QUIPLATT

IMPLICIT NONE

INTEGER, INTENT(IN) :: NAT
DOUBLE PRECISION, DIMENSION(3*NAT), INTENT(IN) :: CRDS
DOUBLE PRECISION, DIMENSION(3*NAT), INTENT(OUT) :: GRAD
DOUBLE PRECISION, INTENT(OUT) :: ENRG

INTEGER :: I
DOUBLE PRECISION, DIMENSION(3,3) :: LATT, VIR
INTEGER ATOMICNUMBER(NATOMS)
DOUBLE PRECISION, DIMENSION(3,NATOMS) :: NEW_COORDS, FORCES
CHARACTER(LEN=3), DIMENSION(NATOMS) :: SYMB

! LATT = RESHAPE((/ BOXX, 0.0D0, 0.0D0, 0.0D0, BOXY, 0.0D0, 0.0D0, 0.0D0, BOXZ /), SHAPE(LATT))
LATT(1:3,1:3)=QUIPLATT(1:3,1:3)

ATOMICNUMBER(1:NATOMS)=QUIPZ

NEW_COORDS = RESHAPE(CRDS, (/ 3, NAT /))

! PRINT*,'before CALL QUIP_WRAPPER_SIMPLE'
CALL QUIP_WRAPPER_SIMPLE(NAT,LATT,ATOMICNUMBER,NEW_COORDS,ENRG,FORCES,VIR)
! PRINT*,'after CALL QUIP_WRAPPER_SIMPLE'
! PRINT*,'NEW_COORDS=',NEW_COORDS
! PRINT*,'ENRG=',ENRG
! PRINT*,'FORCES=',FORCES

!Virial is not passed back to OPTIM

GRAD = RESHAPE(FORCES, SHAPE(GRAD))
DO I = 1, 3*NAT
   GRAD(I) = -1.0D0*GRAD(I)
END DO

END SUBROUTINE OPTIM_QUIP_WRAPPER
