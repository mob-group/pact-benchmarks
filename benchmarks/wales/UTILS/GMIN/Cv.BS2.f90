!
!  Calculate Cv curve from weights and visit statistics
!  for replicas at different temperatures REPT(J1).
!  Minimise chi^2 statistic to extract best probabilities.
!
PROGRAM CVBS
IMPLICIT NONE
DOUBLE PRECISION TMIN, TMAX, TINT, Z0, Z1, Z2, TEMPERATURE, DUMMY, DELTA, ONEMEXP, PSUM, DP, PSUM2, TANAL, DPLUS, DMINUS
DOUBLE PRECISION COLOURTHRESH, HSHIFT, DUMMY2, DWEIGHT, DMIN, DUMMY3, DUMMY4, LN2DSUM, PEMIN, LN1DSUM, DQPLUS, DQMINUS
DOUBLE PRECISION, ALLOCATABLE :: ENERGY(:), LNWEIGHT(:), MEANE(:), ZSAVE(:), PERMINP(:), PERMINM(:), EMIN(:), LNW2D(:,:)
DOUBLE PRECISION, ALLOCATABLE :: QENERGY(:), CQP(:), CQM(:), CHECK1D(:)
INTEGER, ALLOCATABLE :: CLOSEST(:), QBIN(:)
INTEGER, ALLOCATABLE :: MINP(:), MINM(:)
DOUBLE PRECISION, ALLOCATABLE :: PERMINQP(:), PERMINQM(:)
INTEGER, ALLOCATABLE :: MINQP(:),MINQM(:)
INTEGER J1, NTEMP, J2, KAPPA, NPLUS, NMINUS, NDUMMY, NMIN, MAXBIN, NQBINS, NQPLUS, NQMINUS
LOGICAL YESNO, DO2DT
LOGICAL, ALLOCATABLE :: NO1D(:),NO2D(:,:)

OPEN(UNIT=10,FILE='Cv.BS.data',STATUS='OLD')
READ(10,*) TMIN, TMAX, NTEMP, KAPPA, NMIN, MAXBIN
CLOSE(10)
ALLOCATE(MEANE(NTEMP),ZSAVE(NTEMP))

PRINT '(3(A,I10))','bins=',MAXBIN
PRINT '(A,2G15.5,A,I8)','minimum and maximum T for Cv calculation=',TMIN,TMAX,' number of Cv data points=',NTEMP
PRINT '(A,I8)','number of degrees of freedom=',KAPPA

ALLOCATE(ENERGY(MAXBIN),LNWEIGHT(MAXBIN),EMIN(NMIN),QBIN(NMIN),NO1D(MAXBIN))

OPEN(UNIT=10,FILE='min.data',STATUS='OLD')
DO J1=1,NMIN
   READ(10,*) EMIN(J1)
!  PRINT '(A,I8,G20.10)','J1,emin=',J1,EMIN(J1)
ENDDO
CLOSE(10)

OPEN(UNIT=10,FILE='weights.BS',STATUS='OLD')
NO1D(1:MAXBIN)=.TRUE.
PEMIN=HUGE(1.0D0)
DELTA=0.0D0
LN1DSUM=0.0D0
DO J1=1,MAXBIN
   READ(10,*,END=432) NDUMMY,DUMMY,DUMMY2,DUMMY3,DUMMY4
   ENERGY(NDUMMY)=DUMMY2
   LNWEIGHT(NDUMMY)=DUMMY3
   LN1DSUM=LN1DSUM+EXP(DUMMY3)
   NO1D(NDUMMY)=.FALSE.
   IF (ENERGY(NDUMMY).LT.PEMIN) THEN
      PEMIN=ENERGY(NDUMMY)
   ENDIF
   IF (NDUMMY-1.GT.0) THEN
      IF ((.NOT.NO1D(NDUMMY)).AND.(.NOT.NO1D(NDUMMY-1))) DELTA=ENERGY(NDUMMY)-ENERGY(NDUMMY-1)
   ENDIF
ENDDO
432 CONTINUE
CLOSE(10)
LN1DSUM=LOG(LN1DSUM)

TINT=(TMAX-TMIN)/(NTEMP-1)
!
!  Calculate Z0, Z1 and Z2 over the required T range. Omit factors of (kT/h)^kappa,
!  which cancel.
!
OPEN(UNIT=1,FILE='Cv.out.BS',STATUS='UNKNOWN')
DO J1=1,NTEMP
   Z0=0.0D0
   Z1=0.0D0
   Z2=0.0D0
   TEMPERATURE=TMIN+(J1-1)*TINT
   DO J2=1,MAXBIN
      IF (NO1D(J2)) CYCLE
      DUMMY=EXP(-(ENERGY(J2)-PEMIN)/TEMPERATURE+LNWEIGHT(J2))
      Z0=Z0+DUMMY
      Z1=Z1+DUMMY*(ENERGY(J2)-PEMIN)
      Z2=Z2+DUMMY*(ENERGY(J2)-PEMIN)**2
   ENDDO
   MEANE(J1)=Z1/Z0
   ZSAVE(J1)=Z0
   IF (DELTA/TEMPERATURE.LT.1.0D-7) THEN
      ONEMEXP=-DELTA/TEMPERATURE
   ELSE
      ONEMEXP= 1.0D0-EXP(DELTA/TEMPERATURE)
   ENDIF
   WRITE(1,'(7G20.10)') TEMPERATURE, Z0, Z1, Z2, &
  &                     KAPPA/2.0D0 + &
  &                      1.0D0*(1.0D0 - DELTA**2*EXP(DELTA/TEMPERATURE)/(ONEMEXP**2*TEMPERATURE**2)) &
  &                     - (Z1/(Z0*TEMPERATURE))**2 + Z2/(Z0*TEMPERATURE**2), MEANE(J1), ZSAVE(J1)
ENDDO
CLOSE(1)

OPEN(UNIT=1,FILE='prob.out.BS',STATUS='UNKNOWN')
DO J1=1,NTEMP
   TEMPERATURE=TMIN+(J1-1)*TINT
   PSUM=0.0D0
   PSUM2=0.0D0
   DO J2=1,MAXBIN
      IF (NO1D(J2)) CYCLE
      DUMMY=EXP(-(ENERGY(J2)-PEMIN)/TEMPERATURE+LNWEIGHT(J2))
      DP=DUMMY*(ENERGY(J2)-PEMIN-MEANE(J1))/(ZSAVE(J1)*TEMPERATURE**2)
      PSUM=PSUM+DP*(ENERGY(J2)-PEMIN-MEANE(J1))
!     PRINT '(A,2I6,4G20.10)','J1,J2,T,ZSAVE,DUMMY,DP=',J1,J2,TEMPERATURE,ZSAVE(J1),DUMMY,DP
      PSUM2=PSUM2+ZSAVE(J1)*(TEMPERATURE*DP)**2/DUMMY
!     PSUM2=PSUM2+(ZSAVE(J1)/DUMMY)*(TEMPERATURE*DP)**2
   ENDDO
   IF (DELTA/TEMPERATURE.LT.1.0D-7) THEN
      ONEMEXP=-DELTA/TEMPERATURE
   ELSE
      ONEMEXP= 1.0D0-EXP(DELTA/TEMPERATURE)
   ENDIF
   WRITE(1,'(5G20.10)') TEMPERATURE, KAPPA/2.0D0+1.0D0 - DELTA**2*EXP(DELTA/TEMPERATURE)/(ONEMEXP**2*TEMPERATURE**2)+PSUM, &
  &                                  KAPPA/2.0D0+1.0D0 - DELTA**2*EXP(DELTA/TEMPERATURE)/(ONEMEXP**2*TEMPERATURE**2)+PSUM2
ENDDO
CLOSE(1)

INQUIRE(FILE='Tanal.BS',EXIST=YESNO)

IF (YESNO) THEN
   NPLUS=0.0D0
   NMINUS=0.0D0
   DPLUS=0.0D0
   DMINUS=0.0D0
   ALLOCATE(PERMINP(MAXBIN),PERMINM(MAXBIN),MINP(MAXBIN),MINM(MAXBIN))
   OPEN(UNIT=1,FILE='Tanal.BS')
   READ(1,*) TANAL
   COLOURTHRESH=0.9D0
   READ(1,*,END=666) COLOURTHRESH
666 CONTINUE
   PRINT '(2(A,G20.10))','Analysing heat capacity contributions at T=',TANAL,' colour threshold=',COLOURTHRESH
   CLOSE(1)
   TEMPERATURE=TANAL
   Z0=0.0D0
   Z1=0.0D0
   DO J2=1,MAXBIN
      IF (NO1D(J2)) CYCLE
      DUMMY=EXP(-(ENERGY(J2)-PEMIN)/TEMPERATURE+LNWEIGHT(J2))
      Z0=Z0+DUMMY
      Z1=Z1+DUMMY*(ENERGY(J2)-PEMIN)
   ENDDO
   MEANE(1)=Z1/Z0
   ZSAVE(1)=Z0
   DO J2=1,MAXBIN
      IF (NO1D(J2)) CYCLE
      DUMMY=EXP(-(ENERGY(J2)-PEMIN)/TEMPERATURE+LNWEIGHT(J2))
      DP=DUMMY*(ENERGY(J2)-PEMIN-MEANE(1))/(ZSAVE(1)*TEMPERATURE**2)
      DUMMY=DP*(ENERGY(J2)-PEMIN-MEANE(1))
      IF (DP.LT.0.0D0) THEN
         NMINUS=NMINUS+1
         MINM(NMINUS)=J2
         PERMINM(NMINUS)=DUMMY
         DMINUS=DMINUS+DUMMY
      ELSE
         NPLUS=NPLUS+1
         MINP(NPLUS)=J2
         PERMINP(NPLUS)=DUMMY
         DPLUS=DPLUS+DUMMY
      ENDIF
!     PRINT '(A,I6,3G20.10,2I6)','J2,ENERGY(J2)-PEMIN,MEANE,DP,NPLUS,NMINUS=',J2,ENERGY(J2)-PEMIN,MEANE(1),DP,NPLUS,NMINUS
   ENDDO
   DO J2=1,NMINUS
      PERMINM(J2)=PERMINM(J2)/DMINUS
   ENDDO
   DO J2=1,NPLUS
      PERMINP(J2)=PERMINP(J2)/DPLUS
   ENDDO
   CALL SORT(NMINUS,MAXBIN,PERMINM,MINM)
   CALL SORT(NPLUS,MAXBIN,PERMINP,MINP)

   DUMMY=0.0D0
   PRINT '(A)','i bins with negative dp/dT below threshold:'
   DO J2=1,NMINUS
      DUMMY=DUMMY+PERMINM(J2)
      PRINT '(2I6,4G20.10)',J2,MINM(J2),PERMINM(J2),DUMMY,ENERGY(MINM(J2)),ENERGY(MINM(J2))-PEMIN
      IF (DUMMY.GT.COLOURTHRESH) EXIT
   ENDDO
   DUMMY=0.0D0
   PRINT '(A)','i bins with positive dp/dT:'
   DO J2=1,NPLUS
      DUMMY=DUMMY+PERMINP(J2)
      PRINT '(2I6,4G20.10)',J2,MINP(J2),PERMINP(J2),DUMMY,ENERGY(MINP(J2)),ENERGY(MINP(J2))-PEMIN
      IF (DUMMY.GT.COLOURTHRESH) EXIT
   ENDDO

   INQUIRE(FILE='weights.2D.BS',EXIST=DO2DT)
   IF (DO2DT) THEN
      PRINT '(A)','Reading 2D weights from weights.2D.BS'
      OPEN(UNIT=10,FILE='Cv.BS.data',STATUS='OLD')
!
! This itme, look for NQBINS parameter at the end for allocations
!
      READ(10,*) TMIN, TMAX, NTEMP, KAPPA, NMIN, MAXBIN, NQBINS
      CLOSE(10)
      ALLOCATE(LNW2D(NQBINS,MAXBIN),NO2D(NQBINS,MAXBIN),CQP(NQBINS),CQM(NQBINS),QENERGY(NQBINS),CHECK1D(MAXBIN))
      LNW2D(1:NQBINS,1:MAXBIN)=-HUGE(1.0D0)
      NO2D(1:NQBINS,1:MAXBIN)=.TRUE.
      CHECK1D(1:MAXBIN)=0.0D0
      OPEN(UNIT=19,FILE='weights.2D.BS',STATUS='OLD')
      DUMMY=0.0D0
      DO 
         READ(19,*,END=753) J1, J2, DUMMY2, DUMMY3, DWEIGHT
         QENERGY(J1)=DUMMY2
         NO2D(J1,J2)=.FALSE.
         LNW2D(J1,J2)=DWEIGHT
         DUMMY=DUMMY+EXP(DWEIGHT)
         CHECK1D(J2)=CHECK1D(J2)+EXP(DWEIGHT)
      ENDDO
753   CONTINUE
      CLOSE(19)
      LN2DSUM=LOG(DUMMY)
!     PRINT '(A)','compare 1d i bin weights with sums over 2D q bins'
!     DUMMY=0.0D0
!     DO J1=1,MAXBIN
!        IF (CHECK1D(J1).GT.0.0D0) CHECK1D(J1)=LOG(CHECK1D(J1))
!        PRINT '(I8,3G20.10)',J1,CHECK1D(J1),LNWEIGHT(J1),ABS(CHECK1D(J1)-LNWEIGHT(J1))
!        IF (CHECK1D(J1).GT.0.0D0) DUMMY=DUMMY+EXP(CHECK1D(J1))
!     ENDDO
!     DUMMY=LOG(DUMMY)
!     PRINT '(A,3G20.10)','LN2DSUM,DUMMY,LN1DSUM=',LN2DSUM,DUMMY,LN1DSUM

      IF (DELTA/TEMPERATURE.LT.1.0D-7) THEN
         ONEMEXP=-DELTA/TEMPERATURE
      ELSE
         ONEMEXP= 1.0D0-EXP(DELTA/TEMPERATURE)
      ENDIF
      DUMMY=KAPPA/2.0D0 + & 
  &                      1.0D0*(1.0D0 - DELTA**2*EXP(DELTA/TEMPERATURE)/(ONEMEXP**2*TEMPERATURE**2)) &
  &                      + DPLUS+DMINUS

      PRINT '(A,G20.10,A,G20.10)','Looking for total Cv at this T of ',DUMMY,' flux dependent component=',DPLUS+DMINUS

      DO J2=1,NQBINS
         CQP(J2)=0.0D0
         CQM(J2)=0.0D0
         DO J1=1,NPLUS
            IF (NO2D(J2,MINP(J1))) CYCLE
            IF (NO1D(MINP(J1))) CYCLE
!           CQP(J2)=CQP(J2)+PERMINP(J1)*DPLUS*EXP(LNW2D(J2,MINP(J1))-LN2DSUM-LNWEIGHT(MINP(J1))+LN1DSUM)
            CQP(J2)=CQP(J2)+PERMINP(J1)*DPLUS*EXP(LNW2D(J2,MINP(J1))-LNWEIGHT(MINP(J1)))
!           PRINT '(A,3I8,6G20.10)','J2,J1,MINP,PERMINP,DPLUS,LNW2D,LN2DSUM,LNWEIGHT,LN1DSUM=', &
! &                                J2,J1,MINP(J1),PERMINP(J1),DPLUS,LNW2D(J2,MINP(J1)),LN2DSUM,LNWEIGHT(MINP(J1)),LN1DSUM
         ENDDO
         DO J1=1,NMINUS
            IF (NO2D(J2,MINM(J1))) CYCLE
            IF (NO1D(MINM(J1))) CYCLE
!           CQM(J2)=CQM(J2)+PERMINM(J1)*DMINUS*EXP(LNW2D(J2,MINM(J1))-LN2DSUM-LNWEIGHT(MINM(J1))+LN1DSUM)
            CQM(J2)=CQM(J2)+PERMINM(J1)*DMINUS*EXP(LNW2D(J2,MINM(J1))-LNWEIGHT(MINM(J1)))
!           PRINT '(A,3I8,6G20.10)','J2,J1,MINM,PERMINM,DMINUS,LNW2D,LN2DSUM,LNWEIGHT,LN1DSUM=', &
! &                                J2,J1,MINM(J1),PERMINM(J1),DMINUS,LNW2D(J2,MINM(J1)),LN2DSUM,LNWEIGHT(MINM(J1)),LN1DSUM
         ENDDO
      ENDDO
!
! Breakdown of Cv over q bins at TANAL
!
      PRINT '(A,G20.10,A)','Breakdown of Cv over q bins at T=',TEMPERATURE,' q bin, plus, minus, sum, cumulative Cv'
      DUMMY2=0.0D0
      DO J2=1,NQBINS
         DUMMY2=DUMMY2+CQP(J2)+CQM(J2)
         IF (CQP(J2)+CQM(J2).GT.1.0D-10) THEN 
            PRINT '(I8,4G20.10)',J2,CQP(J2),CQM(J2),CQP(J2)+CQM(J2),DUMMY2
         ENDIF
      ENDDO
   
      PRINT '(A,I8,A)','For disconnectionDPS use line TRMIN 2 ',NMIN,' min.minus.BS min.plus.BS and '
      PRINT '(A)','CHOOSECOLOURS in the dinfo file'

      NQPLUS=0.0D0
      NQMINUS=0.0D0
      DQPLUS=0.0D0
      DQMINUS=0.0D0
      ALLOCATE(PERMINQP(NQBINS),PERMINQM(NQBINS),MINQP(NQBINS),MINQM(NQBINS))

      DO J2=1,NQBINS
         IF ((ABS(CQP(J2)).LT.1.0D-10).AND.(ABS(CQM(J2)).LT.1.0D-10)) CYCLE
         IF (CQP(J2)-CQM(J2).LT.0.0D0) THEN
            NQMINUS=NQMINUS+1
            MINQM(NQMINUS)=J2
            PERMINQM(NQMINUS)=CQM(J2)-CQP(J2)
            DQMINUS=DQMINUS+CQM(J2)-CQP(J2)
         ELSE
            NQPLUS=NQPLUS+1
            MINQP(NQPLUS)=J2
            PERMINQP(NQPLUS)=CQP(J2)-CQM(J2)
            DQPLUS=DQPLUS+CQP(J2)-CQM(J2)
         ENDIF
!        PRINT '(A,I8,4G20.10)','J2,CQP,CQM,NQMINUS,NQPLUS=',J2,CQP(J2),CQM(J2),NQMINUS,NQPLUS
      ENDDO
      DO J2=1,NQMINUS
         PERMINQM(J2)=PERMINQM(J2)/MAX(DQMINUS,1.0D-200)
!        PRINT '(A,I8,2G20.10)','J2,PERMINQM,DQMINUS=',J2,PERMINQM(J2),DQMINUS
      ENDDO
      DO J2=1,NQPLUS
         PERMINQP(J2)=PERMINQP(J2)/MAX(DQPLUS,1.0D-200)
!        PRINT '(A,I8,2G20.10)','J2,PERMINQP,DQPLUS=',J2,PERMINQP(J2),DQPLUS
      ENDDO
      CALL SORT(NQMINUS,NQBINS,PERMINQM,MINQM)
      CALL SORT(NQPLUS,NQBINS,PERMINQP,MINQP)
      
      DUMMY=0.0D0
      PRINT '(A)','q bins with negative overall flux below threshold:'
      DO J2=1,NQMINUS
         DUMMY=DUMMY+PERMINQM(J2)
         PRINT '(2I6,4G20.10)',J2,MINQM(J2),PERMINQM(J2),DUMMY,QENERGY(MINQM(J2))
         IF (DUMMY.GT.COLOURTHRESH) EXIT
      ENDDO
      DUMMY=0.0D0
      PRINT '(A)','q bins with positive overall flux below threshold:'
      DO J2=1,NQPLUS
         DUMMY=DUMMY+PERMINQP(J2)
         PRINT '(2I6,4G20.10)',J2,MINQP(J2),PERMINQP(J2),DUMMY,QENERGY(MINQP(J2))
         IF (DUMMY.GT.COLOURTHRESH) EXIT
      ENDDO

      PRINT '(A)','Assignment of minima to quench bins: minimum, pe, q bin, q energy, diff'
      DO J1=1,NMIN
         DMIN=HUGE(1.0D0)
         DO J2=1,NQBINS
            IF (ABS(EMIN(J1)-QENERGY(J2)).LT.DMIN) THEN
               QBIN(J1)=J2
               DMIN=ABS(EMIN(J1)-QENERGY(J2))
            ENDIF
         ENDDO
!        PRINT '(I8,G20.10,I8,2G20.10)',J1,EMIN(J1),QBIN(J1),QENERGY(QBIN(J1)),DMIN
      ENDDO

      OPEN(UNIT=1,FILE='min.minus.BS',STATUS='UNKNOWN')
      DUMMY=0.0D0
      DO J2=1,NQMINUS
         DUMMY=DUMMY+PERMINQM(J2)
         DO J1=1,NMIN
            IF (QBIN(J1).EQ.MINQM(J2)) THEN
               WRITE(1,'(I6)') J1
!              WRITE(*,'(A,3I8,3G20.10)') 'J1, J2, MINQM(J2), EMIN', J1, J2, MINQM(J2), EMIN(J1)
            ENDIF
         ENDDO
         IF (DUMMY.GT.COLOURTHRESH) EXIT
      ENDDO
      CLOSE(1)

      OPEN(UNIT=1,FILE='min.plus.BS',STATUS='UNKNOWN')
      DUMMY=0.0D0
      DO J2=1,NQPLUS
         DUMMY=DUMMY+PERMINQP(J2)
         DO J1=1,NMIN
            IF (QBIN(J1).EQ.MINQP(J2)) THEN
               WRITE(1,'(I6)') J1
!              WRITE(*,'(A,3I6,3G20.10)') 'J1, J2, MINQP(J2), EMIN=', J1, J2, MINQP(J2), EMIN(J1)
            ENDIF
         ENDDO
         IF (DUMMY.GT.COLOURTHRESH) EXIT
      ENDDO 
      CLOSE(1)

   ENDIF
ENDIF

END PROGRAM CVBS

SUBROUTINE SORT(N,J3,A,NA)
IMPLICIT NONE
INTEGER J1, L, N, J3, J2, NA(J3), NTEMP
DOUBLE PRECISION TEMP, A(J3)
!
DO 20 J1=1,N-1
   L=J1
   DO 10 J2=J1+1,N
      IF (A(L).LT.A(J2)) L=J2
10 CONTINUE
   TEMP=A(L)
   A(L)=A(J1)
   A(J1)=TEMP
   NTEMP=NA(L)
   NA(L)=NA(J1)
   NA(J1)=NTEMP
20 CONTINUE
RETURN
END SUBROUTINE SORT

